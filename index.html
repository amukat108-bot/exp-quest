<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f19" />
  <title>EXP Quest</title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a;
      --text:#e7eefc; --muted:#98a5c7;
      --good:#47d18c; --warn:#ffcc66;
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, Arial;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(122,162,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 35%, rgba(71,209,140,.18), transparent 60%),
        var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 80px;}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; padding:14px 0 12px; backdrop-filter: blur(10px);
      z-index: 10;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(71,209,140,.85));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px;
    }
    .title{display:flex; flex-direction:column; line-height:1.1;}
    .title strong{font-size:15px;}
    .title span{font-size:12px; color:var(--muted);}
    .chiprow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:8px 10px; border-radius:999px;
      font-family:var(--mono); font-size:12px; color:var(--text);
    }

    .grid{display:grid; gap:12px; grid-template-columns: 1.05fr .95fr;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr;} header{position:static;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px; font-size:13px; letter-spacing:.2px; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between;
    }

    textarea{
      width:100%; min-height:140px; resize:vertical;
      background: rgba(0,0,0,.22); color:var(--text);
      border:1px solid var(--border); border-radius:14px;
      padding:12px 12px; font-size:14px; line-height:1.55;
      outline:none;
    }

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; justify-content:space-between;}
    .toggles{display:flex; gap:10px; flex-wrap:wrap;}
    .toggle{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      user-select:none;
    }
    .toggle input{transform: scale(1.15);}

    button{
      border:0; cursor:pointer; border-radius:14px;
      padding:12px 14px; font-weight:800; letter-spacing:.2px;
      color:#0b0f19;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(71,209,140,.85));
      box-shadow: var(--shadow);
    }
    button.secondary{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }

    .loglist{display:flex; flex-direction:column; gap:10px; max-height:460px; overflow:auto; padding-right:6px;}
    .entry{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:12px;
    }
    .entry .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family:var(--mono); font-size:12px; color:var(--muted);
    }
    .entry .gain{color: var(--good); font-weight:900;}
    .badge{
      display:inline-flex; gap:6px; align-items:center;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-family:var(--mono); font-size:12px;
    }

    /* Buddy */
    #buddyWrap{
      position: fixed;
      right: 16px;
      bottom: 16px;
      display:flex;
      gap:12px;
      align-items:flex-end;
      z-index: 998;
    }
    #buddy{
      width:88px; height:88px;
      border-radius: 22px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    #buddyBubble{
      width: min(460px, calc(100vw - 140px));
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(18,26,42,.92), rgba(12,16,28,.88));
      box-shadow: var(--shadow);
    }
    #buddyName{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    #buddyText{
      margin-top: 6px;
      font-size: 14px;
      line-height: 1.55;
      color: var(--text);
      white-space: pre-wrap;
    }
    #buddyChips{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .bchip{
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-family: var(--mono);
      font-size: 12px;
    }

    /* FX: toast */
    #toast{
      position:fixed;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding:10px 14px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    #toast.show{opacity:1; transform:translateX(-50%) translateY(6px);}
  </style>
</head>

<body>
  <div id="toast"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">XP</div>
        <div class="title">
          <strong>EXP Quest</strong>
          <span>Buddy conversation XP</span>
        </div>
      </div>
      <div class="chiprow">
        <div class="chip" id="chipLv">Lv 10</div>
        <div class="chip" id="chipExp">EXP 1200</div>
        <div class="chip" id="chipStreak">Streak 0</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>今日のログ <span class="badge" id="badgeToday">—</span></h2>

        <textarea id="logInput" placeholder="例：
・自炊
・SNSを我慢
・読書30分
・重要な気づき
・人に優しくできた
..."></textarea>

        <div class="controls">
          <div class="toggles">
            <label class="toggle"><input type="checkbox" id="tNoSNS" /> SNS使わなかった</label>
            <label class="toggle"><input type="checkbox" id="tDeepWork" /> 深集中できた</label>
            <label class="toggle"><input type="checkbox" id="tRisk" /> 怖いことに踏み込んだ</label>
          </div>
          <div class="row">
            <button class="secondary" id="btnReset">初期化</button>
            <button id="btnStart">会話開始</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>履歴</h2>
        <div class="loglist" id="history"></div>
      </section>
    </div>
  </div>

  <!-- Buddy (amoeba companion) -->
  <div id="buddyWrap" aria-label="buddy">
    <canvas id="buddy" width="220" height="220"></canvas>
    <div id="buddyBubble">
      <div id="buddyName">Amo</div>
      <div id="buddyText">—</div>
      <div id="buddyChips"></div>
    </div>
  </div>

  <script>
    // ---------- utils ----------
    const $ = (id) => document.getElementById(id);
    const nowISODate = () => new Date().toISOString().slice(0,10);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 900);
    }

    // ---------- state ----------
    const KEY = "expquest_v2_convo";

    function loadState(){
      const raw = localStorage.getItem(KEY);
      if (raw){
        try { return JSON.parse(raw); } catch {}
      }
      return {
        totalExp: 1200,
        history: [],
        lastActiveDate: null,
        streak: 0
      };
    }

    function saveState(s){
      localStorage.setItem(KEY, JSON.stringify(s));
    }

    // Lv設計：10スタート。必要EXPは緩いステップ（ウサギ向け＝頻繁にLvUP）
    function levelFromExp(total){
      // Lv10: 0-1499, Lv11:1500-1899, Lv12:1900-2399 ...
      if (total < 1500) return 10;
      if (total < 1900) return 11;
      if (total < 2400) return 12;
      if (total < 3000) return 13;
      if (total < 3700) return 14;
      return 15 + Math.floor((total - 3700) / 900);
    }

    function render(){
      const s = loadState();
      $("badgeToday").textContent = nowISODate();
      $("chipExp").textContent = `EXP ${s.totalExp}`;
      $("chipLv").textContent = `Lv ${levelFromExp(s.totalExp)}`;
      $("chipStreak").textContent = `Streak ${s.streak}`;

      const hist = s.history.slice().reverse();
      const el = $("history");
      el.innerHTML = hist.length ? hist.map(h=>`
        <div class="entry">
          <div class="top">
            <span>${h.date}</span>
            <span class="gain">+${h.gained} EXP</span>
          </div>
          <div style="white-space:pre-wrap;margin-top:8px;">${escapeHTML(h.text)}</div>
        </div>
      `).join("") : `<div style="color:var(--muted);font-size:12px;">まだ履歴がありません。</div>`;
    }

    function escapeHTML(str){
      return (str||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    // ---------- buddy UI ----------
    const buddy = { mood:"idle" };

    function setBuddyText(text, chips=[]){
      $("buddyText").textContent = text;
      const wrap = $("buddyChips");
      wrap.innerHTML = "";
      for (const c of chips){
        const d = document.createElement("div");
        d.className = "bchip";
        d.textContent = c.label;
        d.addEventListener("click", ()=>c.onClick());
        wrap.appendChild(d);
      }
    }

    // Amoeba animation
    (function initBuddy(){
      const canvas = $("buddy");
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      const cx = W/2, cy = H/2;
      let t = 0;

      function moodColor(){
        switch(buddy.mood){
          case "metal": return {a:"rgba(255,204,102,0.95)", b:"rgba(122,162,255,0.85)"};
          case "hype":  return {a:"rgba(122,162,255,0.95)", b:"rgba(255,107,107,0.78)"};
          case "focus": return {a:"rgba(71,209,140,0.90)",  b:"rgba(122,162,255,0.70)"};
          default:      return {a:"rgba(122,162,255,0.75)", b:"rgba(71,209,140,0.70)"};
        }
      }

      function draw(){
        t += 0.016;
        ctx.clearRect(0,0,W,H);

        const c = moodColor();
        const g = ctx.createRadialGradient(cx, cy, 10, cx, cy, 95);
        g.addColorStop(0, c.a);
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx,cy,95,0,Math.PI*2); ctx.fill();

        const baseR = 42;
        const amp = (buddy.mood==="metal") ? 10 : (buddy.mood==="hype"?8:6);
        const points = 64;

        ctx.beginPath();
        for (let i=0;i<=points;i++){
          const a = (i/points)*Math.PI*2;
          const n = Math.sin(a*3 + t*2) * 0.55
                  + Math.sin(a*7 - t*1.6) * 0.30
                  + Math.sin(a*11 + t*1.1) * 0.15;
          const r = baseR + amp*n;
          const x = cx + Math.cos(a)*r;
          const y = cy + Math.sin(a)*r;
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath();

        const lg = ctx.createLinearGradient(cx-50,cy-50,cx+60,cy+60);
        lg.addColorStop(0, c.a);
        lg.addColorStop(1, c.b);
        ctx.fillStyle = lg;
        ctx.fill();

        // eyes
        ctx.fillStyle = "rgba(11,15,25,0.75)";
        ctx.beginPath(); ctx.arc(cx-14, cy-6, 4.8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(cx+14, cy-6, 4.8, 0, Math.PI*2); ctx.fill();

        requestAnimationFrame(draw);
      }
      draw();

      setBuddyText("相棒Amoだ。行動を1行入れろ。会話でXPを払う。", [
        {label:"入力にフォーカス", onClick:()=>{$("logInput").focus();}},
        {label:"例を入れる", onClick:()=>{
          $("logInput").value = "自炊した。SNSを我慢。";
          $("logInput").focus();
        }},
      ]);
    })();

    // ---------- conversation engine ----------
    const convo = {
      stage: "idle",      // idle | q1 | q2 | q3 | toggles | metalConfirm
      text: "",
      tags: { difficulty:1, meaning:1, resist:0, nosns:false, deep:false, risk:false },
      xp: 0,
      metal: false
    };

    function startConversation(){
      const text = $("logInput").value.trim();
      if (!text){
        buddy.mood = "idle";
        toast("ログが空です");
        setBuddyText("ログが空だ。1行でいい。", [
          {label:"入力する", onClick:()=>{$("logInput").focus();}}
        ]);
        return;
      }

      // UIチェックを初期値へ（任意）
      convo.tags.nosns = $("tNoSNS").checked;
      convo.tags.deep  = $("tDeepWork").checked;
      convo.tags.risk  = $("tRisk").checked;

      convo.text = text;
      convo.stage = "q1";
      buddy.mood = "focus";
      $("logInput").value = "";
      $("tNoSNS").checked = false;
      $("tDeepWork").checked = false;
      $("tRisk").checked = false;

      askQ1();
    }

    function askQ1(){
      setBuddyText("質問1/3：難易度は？（直感でOK）", [
        {label:"低", onClick:()=>{convo.tags.difficulty=1; convo.stage="q2"; askQ2();}},
        {label:"中", onClick:()=>{convo.tags.difficulty=2; convo.stage="q2"; askQ2();}},
        {label:"高", onClick:()=>{convo.tags.difficulty=3; convo.stage="q2"; askQ2();}},
      ]);
    }

    function askQ2(){
      setBuddyText("質問2/3：意味（自己の成長・価値）は？", [
        {label:"低", onClick:()=>{convo.tags.meaning=1; convo.stage="q3"; askQ3();}},
        {label:"中", onClick:()=>{convo.tags.meaning=2; convo.stage="q3"; askQ3();}},
        {label:"高", onClick:()=>{convo.tags.meaning=3; convo.stage="q3"; askQ3();}},
      ]);
    }

    function askQ3(){
      setBuddyText("質問3/3：抵抗（面倒/誘惑/怖さ）を突破した？", [
        {label:"NO", onClick:()=>{convo.tags.resist=0; convo.stage="toggles"; askToggles();}},
        {label:"YES", onClick:()=>{convo.tags.resist=1; convo.stage="toggles"; askToggles();}},
      ]);
    }

    function askToggles(){
      setBuddyText("最後：該当するものを選べ（複数OK）→ 確定", [
        {label:`SNS断ち ${convo.tags.nosns?"ON":"OFF"}`, onClick:()=>{convo.tags.nosns=!convo.tags.nosns; askToggles();}},
        {label:`深集中 ${convo.tags.deep?"ON":"OFF"}`, onClick:()=>{convo.tags.deep=!convo.tags.deep; askToggles();}},
        {label:`リスク ${convo.tags.risk?"ON":"OFF"}`, onClick:()=>{convo.tags.risk=!convo.tags.risk; askToggles();}},
        {label:"確定", onClick:()=>finalizeXP()},
      ]);
    }

    function finalizeXP(){
      const {xp, metal} = computeXP(convo.text, convo.tags);
      convo.xp = xp;
      convo.metal = metal;

      if (metal){
        convo.stage = "metalConfirm";
        buddy.mood = "metal";
        toast("★メタル出現");
        setBuddyText(`★メタル反応：+${xp} EXP（討伐で確定）`, [
          {label:"討伐して確定", onClick:()=>commitXP()},
          {label:"逃がす（0）", onClick:()=>{buddy.mood="idle"; setBuddyText("了解。今日は温存。", [{label:"次の1行", onClick:()=>{$("logInput").focus();}}]); resetConvo();}},
        ]);
      } else {
        commitXP();
      }
    }

    function computeXP(text, tags){
      let xp = 40;

      // 軽い自動判定（キーワード）
      if (text.includes("自炊")) xp += 20;
      if (text.includes("読書")) xp += 40;
      if (text.includes("SNS") && (text.includes("減") || text.includes("断") || text.includes("極小") || text.includes("我慢"))) xp += 60;
      if (text.includes("引き継ぎ") || text.includes("優しく") || text.includes("丁寧") || text.includes("配慮")) xp += 30;

      // 主観タグ
      xp += (tags.difficulty - 1) * 35; // 0/35/70
      xp += (tags.meaning - 1) * 45;    // 0/45/90
      xp += tags.resist ? 80 : 0;

      // ブースト
      xp += tags.nosns ? 120 : 0;
      xp += tags.deep  ? 70  : 0;
      xp += tags.risk  ? 90  : 0;

      // メタル（やや出る）
      const p = 0.16 + (tags.deep?0.06:0) + (tags.nosns?0.05:0) + (tags.resist?0.04:0);
      const metal = Math.random() < p;
      if (metal) xp += 200;

      return {xp, metal};
    }

    function commitXP(){
      const s = loadState();
      const beforeLv = levelFromExp(s.totalExp);
      const beforeExp = s.totalExp;

      // streak更新（その日に1回でもXP付与で更新）
      const today = nowISODate();
      if (!s.lastActiveDate){
        s.streak = 1;
      } else if (s.lastActiveDate === today){
        // 今日は既にアクティブ → streak維持
      } else {
        const last = new Date(s.lastActiveDate);
        const t = new Date(today);
        const diffDays = Math.round((t - last) / (1000*60*60*24));
        if (diffDays === 1) s.streak += 1;
        else s.streak = 1;
      }
      s.lastActiveDate = today;

      s.totalExp += convo.xp;
      s.history.push({date: today, text: convo.text, gained: convo.xp});
      saveState(s);
      render();

      const afterLv = levelFromExp(s.totalExp);
      const leveled = afterLv !== beforeLv;

      if (leveled){
        buddy.mood = "hype";
        toast(`Lv UP! ${beforeLv} → ${afterLv}`);
        setBuddyText(`Lv UP（${beforeLv}→${afterLv}）。+${convo.xp} EXP。次の1行。`, [
          {label:"次の1行", onClick:()=>{$("logInput").focus();}},
          {label:"ボスを探す", onClick:()=>{setBuddyText("今日のボス条件：『怖いこと』を1つやれ。", [{label:"了解", onClick:()=>{$("logInput").focus();}}]);}},
        ]);
      } else {
        buddy.mood = (convo.xp >= 250) ? "hype" : "idle";
        toast(`+${convo.xp} EXP`);
        setBuddyText(`+${convo.xp} EXP。次の1行に行け。`, [
          {label:"次の1行", onClick:()=>{$("logInput").focus();}},
          {label:"SNS断ち宣言", onClick:()=>{setBuddyText("宣言を受理。SNSは敵。", [{label:"続ける", onClick:()=>{$("logInput").focus();}}]);}},
        ]);
      }

      resetConvo();
    }

    function resetConvo(){
      convo.stage = "idle";
      convo.text = "";
      convo.tags = { difficulty:1, meaning:1, resist:0, nosns:false, deep:false, risk:false };
      convo.xp = 0;
      convo.metal = false;
    }

    // ---------- controls ----------
    $("btnStart").addEventListener("click", startConversation);

    $("btnReset").addEventListener("click", ()=>{
      if (!confirm("全データを初期化します。よろしいですか？")) return;
      localStorage.removeItem(KEY);
      render();
      buddy.mood = "idle";
      setBuddyText("初期化した。最初の1行を入れろ。", [
        {label:"入力する", onClick:()=>{$("logInput").focus();}},
      ]);
      toast("初期化");
    });

    // 初回描画
    render();
  </script>
</body>
</html>
